# 安装与使用指南

## 目录

- [安装与使用指南](#安装与使用指南)
  - [目录](#目录)
  - [简介](#简介)
  - [环境准备](#环境准备)
    - [1. 安装 Conda](#1-安装-conda)
    - [2. 创建并激活虚拟环境](#2-创建并激活虚拟环境)
    - [3. 安装依赖](#3-安装依赖)
  - [环境变量配置](#环境变量配置)
  - [Azure OpenAI API 配置](#azure-openai-api-配置)
  - [ComfyUI 配置](#comfyui-配置)
    - [1. 安装 ComfyUI](#1-安装-comfyui)
    - [2. 启动 ComfyUI 服务](#2-启动-comfyui-服务)
  - [启动与访问](#启动与访问)
  - [常见问题](#常见问题)
    - [Q: Azure OpenAI 报错 401 或 403？](#q-azure-openai-报错-401-或-403)
    - [Q: ComfyUI 页面无法访问？](#q-comfyui-页面无法访问)

## 简介

本项目集成了 Azure OpenAI 与 ComfyUI，提供强大的推理与视觉处理能力。此文档将指导你完成环境配置、API 接入与服务启动。

## 环境准备

### 1. 安装 Conda

请访问 Conda 官网安装 Miniconda 或 Anaconda。

### 2. 创建并激活虚拟环境

```bash
conda create -n AIGC python=3.10 -y
conda activate AIGC
```

### 3. 安装依赖

确保项目根目录下存在 `requirements.txt` 文件：

```bash
pip install -r requirements.txt
```

## 环境变量配置

请在项目根目录下创建 `.env` 文件，并填入以下内容：

```ini
# 日志等级，可选：DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# ComfyUI 接口配置
COMFYUI_BASE_API_URL=http://127.0.0.1:8188/api
COMFYUI_WEBSOCKET_API_URL=ws://127.0.0.1:8188/ws

# Azure OpenAI 接口配置
AZURE_OPENAI_MODEL=gpt-4
AZURE_OPENAI_API_KEY=你的AzureOpenAI密钥
AZURE_OPENAI_ENDPOINT=https://你的资源名.openai.azure.com/
AZURE_OPENAI_API_VERSION=2023-12-01-preview

# 默认批处理设置（可保持默认）
DEFAULT_BATCHSIZE_USE_ONE_PROMPT=1

# 产品图转海报设置（可保持默认）
IMAGE2POSTER_BATCHSIZE_USE_ONE_PROMPT=1
IMAGE2POSTER_OUTPUT_SIZE_WIDTH=1024
IMAGE2POSTER_OUTPUT_SIZE_HEIGHT=1024
IMAGE2POSTER_SCALE_MIN=0.3
IMAGE2POSTER_SCALE_MAX=0.7
```

> 💡 建议：将 `.env` 文件加入 `.gitignore` 以避免敏感信息泄露。

## Azure OpenAI API 配置

1. 登录 Azure Portal
2. 创建 Azure OpenAI 服务
3. 部署所需模型（如 gpt-4, gpt-35-turbo，或 embedding 模型）
4. 获取以下信息：
   - API Key
   - Endpoint
   - API Version（建议使用官方最新）
   - 部署名称（需与 AZURE_OPENAI_MODEL 保持一致）

## ComfyUI 配置

### 1. 安装 ComfyUI

```bash
git clone https://github.com/comfyanonymous/ComfyUI.git
cd ComfyUI
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### 2. 启动 ComfyUI 服务

```bash
python main.py
```

服务地址：
- Web 界面：http://127.0.0.1:8188
- API 地址：http://127.0.0.1:8188/api
- WebSocket 地址：ws://127.0.0.1:8188/ws

## 启动与访问

确保 `.env` 已配置并保存，ComfyUI 正在运行。然后运行你的主程序：

```bash
python main.py
```

## 常见问题

### Q: Azure OpenAI 报错 401 或 403？

- 请确认 API Key 和 Endpoint 是否正确，是否启用了对应模型
- 检查 `.env` 中模型名称与 Azure 部署名称是否一致

### Q: ComfyUI 页面无法访问？

- 检查是否已运行 main.py
- 确认本地未占用 8188 端口
- 防火墙/安全软件是否拦截